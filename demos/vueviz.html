<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <style src="text/css">
      html,
      body {
        height: 100%;
        margin: 0;
      }
      /* #viz {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      } */
    </style>
    <title>Vue.js and Neovis.js: A Demo</title>
  </head>
  <body>
    <div id="vue-demo" class="d-flex flex-column h-100">
      <div class="container">
        <h1>Vue.js and Neovis.js: A Demo</h1>
        <form @submit.prevent="search">
          <div class="mb-3">
            <label for="search-input" class="form-label">Kana/Kanji search</label>
            <input
              :value="expr"
              type="search"
              class="form-control"
              id="search-input"
              name="searchInput"
              aria-describedby="search-help"
            />
            <div id="search-help" class="form-text">
              Enter kana (or kanji using a Japanese keyboard) to search!
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Search</button>
        </form>
      </div>
      <div class="container-fluid flex-grow-1 position-relative">
        <div id="viz" class="position-absolute top-0 bottom-0 start-0 end-0"></div>
      </div>
      <footer></footer>
    </div>

    <!-- Vue and Neovis JS -->
    <script src="https://unpkg.com/vue@next"></script>
    <script src="https://cdn.neo4jlabs.com/neovis.js/v1.5.0/neovis.js"></script>
    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <!-- Wanakana -->
    <script src="https://unpkg.com/wanakana"></script>
    <script>
      const pos = {
        "adjectival nouns or quasi-adjectives (keiyodoshi)": "adj-na",
        "noun (common) (futsuumeishi)": "n",
        "suffix": "suf",
      }
      const VueDemoApp = {
        data() {
          return {
            expr: "ようこそ",
            viz: new NeoVis.default({
              container_id: "viz",
              server_url: "neo4j://localhost:7687",
              server_user: "neo4j",
              server_password: "japanese",
              labels: {
                "Kanji": {
                  "caption": "keb",
                  "font": {size: 20, face: "sans-serif"},
                },
                "Reading": {
                  "caption": "reb",
                  "font": {size: 20, face: "sans-serif"},
                },
                "Sense": {
                  "caption": (node) => node.properties["pos"].map(s => pos[s]).join("; "),
                  "font": {size: 12, face: "sans-serif"},
                },
                "Gloss": {
                  "caption": (node) => node.properties["defn"].join("\n"),
                  "font": {size: 12, face: "sans-serif"},
                }
              },
              relationships: {
                "IS_READ": {
                  "caption": true
                },
                "IS_DEFINED_BY": {
                  "caption": true
                },
                "HAS_GLOSS": {
                  "caption": true
                }
              }
            })
          }
        },
        methods: {
          search(event) {
            this.expr = event.target.elements.searchInput.value
            let match = wanakana.isKana(this.expr)
              ? `MATCH (target:Reading {reb: "${this.expr}"})`
              : `MATCH (target:Kanji {keb: "${this.expr}"})`
            let cypher = `
${match}
WITH target
MATCH (target)-[s:IS_DEFINED_BY]-(sense:Sense)-[g:HAS_GLOSS]-(gloss:Gloss)
OPTIONAL MATCH (target)-[r:IS_READ]-(other)
RETURN target, other, sense, gloss, r, s, g`
            console.log(cypher)
            if (this.viz._network === null) {
              this.viz.updateWithCypher(cypher)
              this.viz._network.setOptions({autoResize: false})
            } else {
              this.viz.renderWithCypher(cypher)
            }
          }
        },
        mounted() {
          this.$nextTick(() => {
            const searchInput = document.getElementById('search-input')
            wanakana.bind(searchInput, /* options */)  // uses IMEMode with toKana() as default

            this.viz._init(this.viz._config)
            this.search()
          })
        }
      }

      Vue.createApp(VueDemoApp).mount('#vue-demo')
    </script>
  </body>
</html>
